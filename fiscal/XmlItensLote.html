<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Processador de XML NFe</title>

    <style>
        body {
            font-family: Arial, Helvetica, sans-serif;
            font-size: 14px;
        }

        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 10px;
        }

        th, td {
            border: 1px solid #ccc;
            padding: 6px 8px;
            text-align: left;
            vertical-align: top;
        }

        th {
            background-color: #eaeaea;
        }

        .item-header {
            background-color: #f9f9f9;
        }

        .progress-bar {
            width: 100%;
            background-color: #f4f4f4;
            border: 1px solid #ccc;
            height: 20px;
            margin: 15px 0;
            position: relative;
        }

        .progress-bar-inner {
            height: 100%;
            background-color: #4caf50;
            width: 0%;
            transition: width 0.1s linear;
        }

        .progress-text {
            position: absolute;
            width: 100%;
            text-align: center;
            top: 0;
            line-height: 20px;
            font-weight: bold;
        }

        .expand-btn {
            cursor: pointer;
            background-color: #4caf50;
            color: white;
            border: none;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            font-weight: bold;
        }

        .nf-box {
            display: none;
            border: 1px solid #ccc;
            background-color: #fafafa;
            padding: 8px;
            margin-top: 5px;
            font-size: 12px;
            max-width: 450px;
            border-radius: 4px;
            word-wrap: break-word;
        }
    </style>

    <script>
        let itemData = {};

        function updateProgress(percent) {
            const bar = document.getElementById("progressBarInner");
            const text = document.getElementById("progressText");
            bar.style.width = percent + "%";
            text.textContent = percent.toFixed(0) + "%";
        }

        async function processXML() {
            const files = document.getElementById("xmlFile").files;
            if (files.length === 0) {
                alert("Selecione um ou mais arquivos XML.");
                return;
            }

            itemData = {};
            const total = files.length;

            for (let i = 0; i < total; i++) {
                await readXMLFile(files[i]);
                updateProgress(((i + 1) / total) * 100);
                if (i % 50 === 0) await new Promise(r => setTimeout(r, 0));
            }

            renderTable();
        }

        function readXMLFile(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const parser = new DOMParser();
                    const xmlDoc = parser.parseFromString(event.target.result, "application/xml");

                    const infNFe = xmlDoc
                        .getElementsByTagName("infNFe")[0]
                        ?.getAttribute("Id")
                        ?.replace("NFe", "") || "Sem chave";

                    const items = xmlDoc.getElementsByTagName("det");

                    for (let item of items) {
                        const descricao = item.getElementsByTagName("xProd")[0]?.textContent || "Sem descrição";
                        const ncm = item.getElementsByTagName("NCM")[0]?.textContent || "Sem NCM";
                        const quantidade = parseFloat(item.getElementsByTagName("qCom")[0]?.textContent) || 0;
                        const valorUnitario = parseFloat(item.getElementsByTagName("vUnCom")[0]?.textContent) || 0;
                        const valorTotal = parseFloat(item.getElementsByTagName("vProd")[0]?.textContent) || 0;

                        if (!itemData[descricao]) {
                            itemData[descricao] = {
                                ncm: ncm,
                                quantidade: 0,
                                valorUnitario: valorUnitario,
                                valorTotal: 0,
                                chaves: new Set()
                            };
                        }

                        itemData[descricao].quantidade += quantidade;
                        itemData[descricao].valorTotal += valorTotal;
                        itemData[descricao].chaves.add(infNFe);
                    }

                    resolve();
                };
                reader.readAsText(file);
            });
        }

        function renderTable() {
            const tbody = document.getElementById("itemTable");
            const uniqueCount = document.getElementById("uniqueCount");

            tbody.innerHTML = "";

            const entries = Object.entries(itemData)
                .sort((a, b) => a[0].localeCompare(b[0]));

            uniqueCount.textContent = entries.length;

            entries.forEach(([descricao, data]) => {
                const tr = document.createElement("tr");
                tr.className = "item-header";

                tr.innerHTML = `
                    <td>${descricao}</td>
                    <td>${data.ncm}</td>
                    <td>${data.quantidade.toFixed(2)}</td>
                    <td>${data.valorUnitario.toFixed(2)}</td>
                    <td>${data.valorTotal.toFixed(2)}</td>
                    <td>
                        <button class="expand-btn" onclick="toggleNotas(this)">+</button>
                        <div class="nf-box">${Array.from(data.chaves).join("<br>")}</div>
                    </td>
                `;

                tbody.appendChild(tr);
            });
        }

        function toggleNotas(btn) {
            const box = btn.nextElementSibling;
            if (box.style.display === "block") {
                box.style.display = "none";
                btn.textContent = "+";
            } else {
                box.style.display = "block";
                btn.textContent = "−";
            }
        }
    </script>
</head>

<body>

    <h2>Importar XML da Nota Fiscal Eletrônica (Lote)</h2>

    <div style="position:absolute; top:10px; right:20px; font-size:13px;">
        AAC by Alexandre Fellinne
    </div>

    <input type="file" id="xmlFile" multiple accept=".xml">
    <button onclick="processXML()">Processar Arquivos</button>

    <div class="progress-bar">
        <div id="progressBarInner" class="progress-bar-inner"></div>
        <div id="progressText" class="progress-text">0%</div>
    </div>

    <h3>Itens Agrupados por Descrição</h3>
    <strong>Itens Únicos:</strong> <span id="uniqueCount">0</span>

    <table>
        <thead>
            <tr>
                <th>Descrição</th>
                <th>NCM</th>
                <th>Quantidade Total</th>
                <th>Valor Unitário</th>
                <th>Valor Total</th>
                <th>Chaves NFe</th>
            </tr>
        </thead>
        <tbody id="itemTable"></tbody>
    </table>

</body>
</html>
